xlab = "support",
ylab = "density",
main = "density plot",
legend_position = "topright")
x <- bmixture::rmixnorm(n = n, weight = c(1/3, 1/3, 1/3), mean = c(-5, 0, +5), sd = c(1, 1, 1))
results <- fit_stationary_gev_mixture_model(x = x,
block_sizes = NULL,
minimum_nblocks = 50,
threshold = NULL,
confidence_level = 0.95,
use_extremal_index = TRUE,
use_uniform_prior = TRUE,
method = c("MLE", "GMLE", "Lmoments")[1])
names(results)
results$weights
results$full_normalized_gev_parameters_object
fit_stationary_gev_mixture_model <- function(x,
nlargest = Inf,
block_sizes = NULL,
minimum_nblocks = 50,
threshold = NULL,
confidence_level = 0.95,
use_extremal_index = TRUE,
use_uniform_prior = TRUE,
method = c("MLE", "GMLE", "Lmoments")[1]){
# x: vector of observations
# nlargest: number of largest values to focus on. Note that the whole vector x is used unless, nlargest != Inf.
# block_sizes: vector containing the sizes of blocks to consider
# threshold: lower bound of block maxima
# use_extremal_index: a boolean which indicates whether to use the estimates extremal indexes or not
# use_uniform_prior: a boolean which indicates whether to use a uniform prior (TRUE) or a pessimistic prior (FALSE)
# confidence_level: desired confidence level when extraction equivalent block sizes.
#                   Note that this value is ignored if block_sizes != NULL.
# minimum_nblocks: desired minimum number of blocks. Note that this number is used to infer the largest block size.
#                  Moreover, this number is ignored if block_sizes != NULL.
# method: estimation method to use
# create an empty output object
output <- list()
# get the dataset of observations
raw_data <- x
# extract the sample of largest values to use
x <- extract_nlargest_sample(x = raw_data, n = nlargest)
# get candidate block sizes
if (is.null(block_sizes)){
candidate_block_sizes <- get_candidate_block_sizes(x = x,
threshold = threshold,
m = minimum_nblocks)
}
else{
candidate_block_sizes <- block_sizes
}
# get equivalent block sizes
equivalent_block_sizes_object <- estimate_several_standardized_block_maxima_mean(x = x,
block_sizes = candidate_block_sizes,
confidence_level = confidence_level,
method = method)
equivalent_block_sizes <- as.numeric(rownames(equivalent_block_sizes_object$selected))
# get eventual rejected block sizes from the equivalent ones
unequivalent_block_sizes <- as.numeric(rownames(equivalent_block_sizes_object$rejected))
# find the threshold above which data are used to estimate weights
threshold <- find_threshold_associated_with_given_block_size(x = x,
block_size = min(equivalent_block_sizes))
# estimate several gev models associated with the equivalent block sizes
gev_models <- estimate_several_gev_models(x = x,
block_sizes = equivalent_block_sizes,
method = method)
# estimate the gev model weights
automatic_weights_object <- estimate_gev_mixture_model_automatic_weights(gev_models = gev_models,
use_uniform_prior = use_uniform_prior,
use_extremal_index = use_extremal_index)
# extract the selected block sizes
selected_block_sizes <- automatic_weights_object$selected_block_sizes
# extract the unselected block sizes
unselected_block_sizes <- automatic_weights_object$unselected_block_sizes
# extract the labels of selected models
selected_model_labels <- automatic_weights_object$selected_model_labels
# extract the vector of selected models per observation
selected_model_per_obs <- automatic_weights_object$selected_model_per_obs
# extract the vector of frequencies
frequencies <- as.numeric(table(selected_model_per_obs))
names(frequencies) <- selected_block_sizes
# extract the vector of weights
weights <- automatic_weights_object$weights
names(weights) <- selected_block_sizes
# extract all estimated gev model objects
gev_models_objects <- gev_models$gev_models_object
# extract the selected gev models
selected_gev_models <- lapply(selected_model_labels, function(k){
model <- gev_models_objects[[k]]
model
})
names(selected_gev_models) <- selected_block_sizes
# extract the extremal indexes associated with the selected gev models
extremal_indexes <- gev_models$extremal_indexes[selected_model_labels]
# extract the unnormalized gev parameters associated with the selected gev models
unnormalized_gev_parameters_object <- gev_models$unnormalized_gev_parameters_object[selected_model_labels, ]
# extract the normalized gev parameters associated with the selected gev models
normalized_gev_parameters_object <- gev_models$normalized_gev_parameters_object[selected_model_labels, ]
# extract the full normalized gev parameters associated with the selected gev models
full_normalized_gev_parameters_object <- gev_models$full_normalized_gev_parameters_object[selected_model_labels, ]
# extract the negative log-likelihood associated with the selected gev models
nllh <- sapply(selected_gev_models, function(model){
res <- summary(model, silent = TRUE)
res$nllh
})
names(nllh) <- selected_block_sizes
# calculate the information criteria, namely aic and bic
p <- nrow(normalized_gev_parameters_object)
q <- ncol(normalized_gev_parameters_object)
aic <- 2*sum(nllh) + 2*(q*p + p - 1)
bic <- 2*sum(nllh) + log(n)*(q*p + p - 1)
information_criteria <- c(aic, bic)
names(information_criteria) <- c("AIC", "BIC")
# update the output object
output[["threshold"]] <- threshold
output[["equivalent_block_sizes"]] <- equivalent_block_sizes
output[["unequivalent_block_sizes"]] <- unequivalent_block_sizes
output[["selected_block_sizes"]] <- selected_block_sizes
output[["unselected_block_sizes"]] <- unselected_block_sizes
output[["weights"]] <- weights
output[["frequencies"]] <- frequencies
output[["use_extremal_index"]] <- use_extremal_index
output[["extremal_indexes"]] <- extremal_indexes
output[["negative_log_likelihoods"]] <- nllh
output[["information_criteria"]] <- information_criteria
output[["unnormalized_gev_parameters_object"]] <- unnormalized_gev_parameters_object
output[["normalized_gev_parameters_object"]] <- normalized_gev_parameters_object
output[["full_normalized_gev_parameters_object"]] <- full_normalized_gev_parameters_object
output[["selected_model_per_obs"]] <- selected_model_per_obs
output[["data"]] <- x
output[["raw_data"]] <- raw_data
output[["selected_gev_models"]] <- selected_gev_models
output
}
results <- fit_stationary_gev_mixture_model(x = x,
block_sizes = NULL,
minimum_nblocks = 50,
threshold = NULL,
confidence_level = 0.95,
use_extremal_index = TRUE,
use_uniform_prior = TRUE,
method = c("MLE", "GMLE", "Lmoments")[1])
source("./src/extract_nlargest_sample.R")
results <- fit_stationary_gev_mixture_model(x = x,
block_sizes = NULL,
minimum_nblocks = 50,
threshold = NULL,
confidence_level = 0.95,
use_extremal_index = TRUE,
use_uniform_prior = TRUE,
method = c("MLE", "GMLE", "Lmoments")[1])
names(results)
results$weights
results$normalized_gev_parameters_object
plot_fit_stationary_gev_mixture_model(gev_mixture_model_object = results,
xlab = "support",
ylab = "density",
main = "density plot",
legend_position = "topright")
plot_several_standardized_block_maxima_mean(x = x,
block_sizes = results$selected_block_sizes,
confidence_level = 0.95,
equivalent = FALSE,
method = c("MLE", "GMLE", "Lmoments")[1])
plot_several_standardized_block_maxima_mean(x = x,
block_sizes = results$selected_block_sizes,
confidence_level = 0.95,
equivalent = TRUE,
method = c("MLE", "GMLE", "Lmoments")[1])
results <- fit_stationary_gev_mixture_model(x = x,
nlargest = 3000,
block_sizes = NULL,
minimum_nblocks = 50,
threshold = NULL,
confidence_level = 0.95,
use_extremal_index = TRUE,
use_uniform_prior = TRUE,
method = c("MLE", "GMLE", "Lmoments")[1])
names(results)
results$weights
results$unnormalized_gev_parameters_object
plot_fit_stationary_gev_mixture_model(gev_mixture_model_object = results,
xlab = "support",
ylab = "density",
main = "density plot",
legend_position = "topright")
n <- 3000
x <- bmixture::rmixnorm(n = n, weight = c(1/3, 1/3, 1/3), mean = c(-5, 0, +5), sd = c(1, 1, 1))
results <- fit_stationary_gev_mixture_model(x = x,
nlargest = 1000,
block_sizes = NULL,
minimum_nblocks = 50,
threshold = NULL,
confidence_level = 0.95,
use_extremal_index = TRUE,
use_uniform_prior = TRUE,
method = c("MLE", "GMLE", "Lmoments")[1])
results$weights
results$full_normalized_gev_parameters_object
plot_fit_stationary_gev_mixture_model(gev_mixture_model_object = results,
xlab = "support",
ylab = "density",
main = "density plot",
legend_position = "topright")
fit_stationary_gev_mixture_model <- function(x,
nlargest = Inf,
block_sizes = NULL,
minimum_nblocks = 50,
threshold = NULL,
confidence_level = 0.95,
use_extremal_index = TRUE,
use_uniform_prior = TRUE,
method = c("MLE", "GMLE", "Lmoments")[1]){
# x: vector of observations
# nlargest: number of largest values to focus on. Note that the whole vector x is used unless, nlargest != Inf.
# block_sizes: vector containing the sizes of blocks to consider
# threshold: lower bound of block maxima
# use_extremal_index: a boolean which indicates whether to use the estimates extremal indexes or not
# use_uniform_prior: a boolean which indicates whether to use a uniform prior (TRUE) or a pessimistic prior (FALSE)
# confidence_level: desired confidence level when extraction equivalent block sizes.
#                   Note that this value is ignored if block_sizes != NULL.
# minimum_nblocks: desired minimum number of blocks. Note that this number is used to infer the largest block size.
#                  Moreover, this number is ignored if block_sizes != NULL.
# method: estimation method to use
# create an empty output object
output <- list()
# get the dataset of all observations
all_data <- x
# extract the sample of largest values to use
partial_data <- extract_nlargest_sample(x = all_data, n = nlargest)
# get candidate block sizes
if (is.null(block_sizes)){
candidate_block_sizes <- get_candidate_block_sizes(x = partial_data,
threshold = threshold,
m = minimum_nblocks)
}
else{
candidate_block_sizes <- block_sizes
}
# get equivalent block sizes
equivalent_block_sizes_object <- estimate_several_standardized_block_maxima_mean(x = partial_data,
block_sizes = candidate_block_sizes,
confidence_level = confidence_level,
method = method)
equivalent_block_sizes <- as.numeric(rownames(equivalent_block_sizes_object$selected))
# get eventual rejected block sizes from the equivalent ones
unequivalent_block_sizes <- as.numeric(rownames(equivalent_block_sizes_object$rejected))
# find the threshold above which data are used to estimate weights
threshold <- find_threshold_associated_with_given_block_size(x = partial_data,
block_size = min(equivalent_block_sizes))
# estimate several gev models associated with the equivalent block sizes
gev_models <- estimate_several_gev_models(x = partial_data,
block_sizes = equivalent_block_sizes,
method = method)
# estimate the gev model weights
automatic_weights_object <- estimate_gev_mixture_model_automatic_weights(gev_models = gev_models,
use_uniform_prior = use_uniform_prior,
use_extremal_index = use_extremal_index)
# extract the selected block sizes
selected_block_sizes <- automatic_weights_object$selected_block_sizes
# extract the unselected block sizes
unselected_block_sizes <- automatic_weights_object$unselected_block_sizes
# extract the labels of selected models
selected_model_labels <- automatic_weights_object$selected_model_labels
# extract the vector of selected models per observation
selected_model_per_obs <- automatic_weights_object$selected_model_per_obs
# extract the vector of frequencies
frequencies <- as.numeric(table(selected_model_per_obs))
names(frequencies) <- selected_block_sizes
# extract the vector of weights
weights <- automatic_weights_object$weights
names(weights) <- selected_block_sizes
# extract all estimated gev model objects
gev_models_objects <- gev_models$gev_models_object
# extract the selected gev models
selected_gev_models <- lapply(selected_model_labels, function(k){
model <- gev_models_objects[[k]]
model
})
names(selected_gev_models) <- selected_block_sizes
# extract the extremal indexes associated with the selected gev models
extremal_indexes <- gev_models$extremal_indexes[selected_model_labels]
# extract the unnormalized gev parameters associated with the selected gev models
unnormalized_gev_parameters_object <- gev_models$unnormalized_gev_parameters_object[selected_model_labels, ]
# extract the normalized gev parameters associated with the selected gev models
normalized_gev_parameters_object <- gev_models$normalized_gev_parameters_object[selected_model_labels, ]
# extract the full normalized gev parameters associated with the selected gev models
full_normalized_gev_parameters_object <- gev_models$full_normalized_gev_parameters_object[selected_model_labels, ]
# extract the negative log-likelihood associated with the selected gev models
nllh <- sapply(selected_gev_models, function(model){
res <- summary(model, silent = TRUE)
res$nllh
})
names(nllh) <- selected_block_sizes
# calculate the information criteria, namely aic and bic
p <- nrow(normalized_gev_parameters_object)
q <- ncol(normalized_gev_parameters_object)
aic <- 2*sum(nllh) + 2*(q*p + p - 1)
bic <- 2*sum(nllh) + log(n)*(q*p + p - 1)
information_criteria <- c(aic, bic)
names(information_criteria) <- c("AIC", "BIC")
# update the output object
output[["threshold"]] <- threshold
output[["equivalent_block_sizes"]] <- equivalent_block_sizes
output[["unequivalent_block_sizes"]] <- unequivalent_block_sizes
output[["selected_block_sizes"]] <- selected_block_sizes
output[["unselected_block_sizes"]] <- unselected_block_sizes
output[["weights"]] <- weights
output[["frequencies"]] <- frequencies
output[["use_extremal_index"]] <- use_extremal_index
output[["extremal_indexes"]] <- extremal_indexes
output[["negative_log_likelihoods"]] <- nllh
output[["information_criteria"]] <- information_criteria
output[["unnormalized_gev_parameters_object"]] <- unnormalized_gev_parameters_object
output[["normalized_gev_parameters_object"]] <- normalized_gev_parameters_object
output[["full_normalized_gev_parameters_object"]] <- full_normalized_gev_parameters_object
output[["selected_model_per_obs"]] <- selected_model_per_obs
output[["partial_data"]] <- partial_data
output[["all_data"]] <- all_data
output[["selected_gev_models"]] <- selected_gev_models
output
}
n <- 3000
x <- bmixture::rmixnorm(n = n, weight = c(1/3, 1/3, 1/3), mean = c(-5, 0, +5), sd = c(1, 1, 1))
results <- fit_stationary_gev_mixture_model(x = x,
nlargest = 1000,
block_sizes = NULL,
minimum_nblocks = 50,
threshold = NULL,
confidence_level = 0.95,
use_extremal_index = TRUE,
use_uniform_prior = TRUE,
method = c("MLE", "GMLE", "Lmoments")[1])
names(results)
results$weights
results$normalized_gev_parameters_object
plot_fit_stationary_gev_mixture_model(gev_mixture_model_object = results,
xlab = "support",
ylab = "density",
main = "density plot",
legend_position = "topright")
plot_fit_stationary_gev_mixture_model <- function(gev_mixture_model_object,
xlab = "support",
ylab = "density",
main = "density plot",
legend_position = "topright"){
# gev_mixture_model_object: an object associated with a result of the function "fit_stationary_gev_mixture_model()"
# xlab: label of the x-axis
# ylab: label of the y-axis
# main: title of the plot
# legend_position: position of the legend
x <- gev_mixture_model_object$partial_data
threshold <- gev_mixture_model_object$threshold
modes_object <- calculate_modes(x = x)
support <- modes_object$density_support
empirical_density <- modes_object$denity_values
if (gev_mixture_model_object$use_extremal_index){
normalized_gev_parameters <- gev_mixture_model_object$full_normalized_gev_parameters_object
}
else{
normalized_gev_parameters <- gev_mixture_model_object$normalized_gev_parameters_object
}
shapes <- normalized_gev_parameters$shape_star
scales <- normalized_gev_parameters$scale_star
locations <- normalized_gev_parameters$loc_star
weights <- gev_mixture_model_object$weights
if (length(weights) == 1){
theoretical_densities <- calculate_gev_pdf(x = support,
loc = locations,
scale = scales,
shape = shapes)
densities <- c(empirical_density, theoretical_densities)
plot(x = support,
y = empirical_density,
type = "l",
ylim = range(densities),
xlab = xlab,
ylab = ylab,
main = main,
lwd = 2)
lines(support, theoretical_densities, col = 3, lwd = 2)
abline(h = 0, lty = "dotted")
abline(v = threshold, lty = "dotted")
legend(legend_position,
legend = c("empirical", "gev"),
lty = c(1, 1), col = c(1, 3))
} else{
theoretical_densities_1 <- calculate_gev_mixture_model_pdf(x = support,
locations = locations,
scales =  scales,
shapes = shapes,
weights = weights,
kind = c("geometric", "arithmetic")[1])
theoretical_densities_2 <- calculate_gev_mixture_model_pdf(x = support,
locations = locations,
scales =  scales,
shapes = shapes,
weights = weights,
kind = c("geometric", "arithmetic")[2])
densities <- c(empirical_density, theoretical_densities_1, theoretical_densities_2)
plot(x = support,
y = empirical_density,
type = "l",
ylim = range(densities),
xlab = xlab,
ylab = ylab,
main = main,
lwd = 2)
lines(support, theoretical_densities_1, col = 6, lwd = 2)
lines(support, theoretical_densities_2, col = 7, lwd = 2)
abline(h = 0, lty = "dotted")
abline(v = threshold, lty = "dotted")
legend(legend_position,
legend = c("empirical", "geometric", "arithmetic"),
lty = c(1, 1, 1), col = c(1, 6, 7))
}
}
plot_fit_stationary_gev_mixture_model(gev_mixture_model_object = results,
xlab = "support",
ylab = "density",
main = "density plot",
legend_position = "topright")
results <- fit_stationary_gev_mixture_model(x = x,
nlargest = 1000,
block_sizes = NULL,
minimum_nblocks = 50,
threshold = NULL,
confidence_level = 0.95,
use_extremal_index = TRUE,
use_uniform_prior = FALSE,
method = c("MLE", "GMLE", "Lmoments")[1])
results$weights
results$unnormalized_gev_parameters_object
plot_fit_stationary_gev_mixture_model(gev_mixture_model_object = results,
xlab = "support",
ylab = "density",
main = "density plot",
legend_position = "topright")
n <- 10000
x <- bmixture::rmixnorm(n = n, weight = c(1/3, 1/3, 1/3), mean = c(-5, 0, +5), sd = c(1, 1, 1))
results <- fit_stationary_gev_mixture_model(x = x,
nlargest = 3000,
block_sizes = NULL,
minimum_nblocks = 50,
threshold = NULL,
confidence_level = 0.95,
use_extremal_index = TRUE,
use_uniform_prior = FALSE,
method = c("MLE", "GMLE", "Lmoments")[1])
results$weights
results$unnormalized_gev_parameters_object
plot_fit_stationary_gev_mixture_model(gev_mixture_model_object = results,
xlab = "support",
ylab = "density",
main = "density plot",
legend_position = "topright")
results$normalized_gev_parameters_object
n <- 10000
loc <- 0
scale <- 1
shape <- 0.01
x <- generate_gev_sample(n = n, loc = loc, scale = scale, shape = shape)
#x <- rnorm(n)
results <- fit_stationary_gev_mixture_model(x = x,
nlargest = Inf,
block_sizes = NULL,
minimum_nblocks = 50,
threshold = NULL,
confidence_level = 0.95,
use_extremal_index = TRUE,
use_uniform_prior = TRUE,
method = c("MLE", "GMLE", "Lmoments")[1])
names(results)
results$weights
results$full_normalized_gev_parameters_object
plot_fit_stationary_gev_mixture_model(gev_mixture_model_object = results,
xlab = "support",
ylab = "density",
main = "density plot",
legend_position = "topright")
results <- fit_stationary_gev_mixture_model(x = x,
nlargest = 3000,
block_sizes = NULL,
minimum_nblocks = 50,
threshold = NULL,
confidence_level = 0.95,
use_extremal_index = TRUE,
use_uniform_prior = TRUE,
method = c("MLE", "GMLE", "Lmoments")[1])
results$weights
results$full_normalized_gev_parameters_object
plot_fit_stationary_gev_mixture_model(gev_mixture_model_object = results,
xlab = "support",
ylab = "density",
main = "density plot",
legend_position = "topright")
results <- fit_stationary_gev_mixture_model(x = x,
nlargest = 2000,
block_sizes = NULL,
minimum_nblocks = 50,
threshold = NULL,
confidence_level = 0.95,
use_extremal_index = TRUE,
use_uniform_prior = TRUE,
method = c("MLE", "GMLE", "Lmoments")[1])
results$weights
results$full_normalized_gev_parameters_object
plot_fit_stationary_gev_mixture_model(gev_mixture_model_object = results,
xlab = "support",
ylab = "density",
main = "density plot",
legend_position = "topright")
